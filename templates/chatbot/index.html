{% extends "base.html" %}

{% block title %}Nexus360{% endblock %}

{% block extra_css %}
<!-- Include the enhanced CSS styles -->
<style>
/* Enhanced Chat Interface Styles */
:root {
    --primary-color: #4a6fa5;
    --secondary-color: #166088;
    --accent-color: #4fc3a1;
    --light-bg: #f8f9fa;
    --dark-text: #343a40;
    --message-bubble-user: #4a6fa5;
    --message-bubble-bot: #f1f3a5;
    --message-text-user: #ffffff;
    --message-text-bot: #343a40;
    --chat-bg: #ffffff;
    --border-radius-lg: 18px;
    --border-radius-md: 12px;
    --border-radius-sm: 8px;
    --shadow-soft: 0 5px 15px rgba(0,0,0,0.05);
    --shadow-medium: 0 8px 20px rgba(0,0,0,0.1);
    --transition-smooth: all 0.3s ease;
}

.chat-container {
    height: 550px;
    overflow-y: auto;
    background-color: var(--chat-bg);
    border-radius: var(--border-radius-lg);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-soft);
    scrollbar-width: thin;
    scrollbar-color: var(--secondary-color) transparent;
}

.chat-container::-webkit-scrollbar {
    width: 6px;
}

.chat-container::-webkit-scrollbar-track {
    background: transparent;
}

.chat-container::-webkit-scrollbar-thumb {
    background-color: rgba(22, 96, 136, 0.3);
    border-radius: 20px;
}

.message {
    margin-bottom: 18px;
    padding: 12px 18px;
    border-radius: var(--border-radius-lg);
    max-width: 80%;
    word-wrap: break-word;
    position: relative;
    transition: var(--transition-smooth);
    box-shadow: var(--shadow-soft);
    line-height: 1.5;
}

.message:hover {
    box-shadow: var(--shadow-medium);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
    font-size: 0.8rem;
    opacity: 0.7;
}

.message-actions {
    display: flex;
    gap: 8px;
    margin-top: 5px;
}

.message-action-btn {
    background: none;
    border: none;
    color: inherit;
    opacity: 0.6;
    cursor: pointer;
    padding: 2px;
    transition: all 0.2s ease;
}

.message-action-btn:hover {
    opacity: 1;
    transform: scale(1.1);
}

.user-message {
    background-color: var(--message-bubble-user);
    color: var(--message-text-user);
    margin-left: auto;
    border-bottom-right-radius: 5px;
}

.bot-message {
    background-color: var(--message-bubble-bot);
    color: var(--message-text-bot);
    margin-right: auto;
    border-bottom-left-radius: 5px;
}

.message-timestamp {
    font-size: 0.75rem;
    opacity: 0.8;
}

.message-source {
    font-size: 11px;
    font-weight: 500;
    margin-top: 6px;
    text-align: right;
    opacity: 0.8;
}

.bot-message .message-source {
    color: #6c757d;
}

.user-message .message-source {
    color: rgba(255, 255, 255, 0.8);
}

/* Star feature */
.starred {
    position: relative;
}

.starred::before {
    content: 'â˜…';
    position: absolute;
    top: -10px;
    right: -10px;
    font-size: 1.5rem;
    color: #ffc107;
    z-index: 1;
    text-shadow: 0 0 3px rgba(0,0,0,0.3);
    animation: star-pulse 1s ease;
}

@keyframes star-pulse {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

/* Improved typing indicator */
.typing-indicator {
    display: none;
    padding: 15px;
    background-color: var(--message-bubble-bot);
    border-radius: var(--border-radius-lg);
    margin-bottom: 15px;
    width: auto;
    max-width: 100px;
    border-bottom-left-radius: 5px;
    box-shadow: var(--shadow-soft);
    position: relative;
}

.typing-indicator .dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--secondary-color);
    margin-right: 4px;
    animation: typing-dot 1.3s infinite ease-in-out;
}

.typing-indicator .dot:nth-child(1) {
    animation-delay: 0s;
}

.typing-indicator .dot:nth-child(2) {
    animation-delay: 0.15s;
}

.typing-indicator .dot:nth-child(3) {
    animation-delay: 0.3s;
    margin-right: 0;
}

@keyframes typing-dot {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-8px); }
}

/* Export chat button */
.export-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 10;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--message-bubble-bot);
    color: var(--dark-text);
    border: none;
    box-shadow: var(--shadow-medium);
    transition: all 0.2s ease;
}

.export-btn:hover {
    transform: scale(1.1);
    background-color: var(--accent-color);
    color: white;
}

.chat-container-wrapper {
    position: relative;
}

/* Adding code block styling for better code display in messages */
.bot-message pre {
    background-color: rgba(0, 0, 0, 0.05);
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: #333;
}

.bot-message code {
    font-family: 'Courier New', monospace;
    background-color: rgba(0, 0, 0, 0.05);
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 90%;
    color: #d63384;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .message {
        max-width: 90%;
    }
    
    .chat-container {
        height: 450px;
        padding: 15px;
    }
}

/* Animations */
.message {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Improve welcome message appearance */
.app-title {
    color: var(--primary-color);
    font-weight: 700;
}

/* New styles for the starred conversations modal */
.starred-conversation {
    background-color: white;
    border: 1px solid rgba(0, 0, 0, 0.125) !important;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
    transition: all 0.3s ease;
}

.starred-conversation:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.user-question {
    background-color: rgba(74, 111, 165, 0.1);
    border-left: 3px solid #4a6fa5 !important;
}

.assistant-response {
    background-color: #f0f4f8;
    border-left: 3px solid #4fc3a1 !important;
    color: #333;
}

/* Dark mode adjustments for starred messages */
[data-theme="dark"] .assistant-response {
    background-color: #2a3038;
    color: #e9ecef;
    border-left: 3px solid #56d7b2 !important;
}

/* Message content styling in starred conversations */
.message-content {
    line-height: 1.6;
    white-space: pre-line;
}

/* Add better styling to code blocks in starred messages */
.starred-conversation pre,
.starred-conversation code {
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 4px;
    padding: 2px 5px;
    font-family: 'Courier New', monospace;
}

[data-theme="dark"] .starred-conversation pre,
[data-theme="dark"] .starred-conversation code {
    background-color: rgba(0, 0, 0, 0.3);
    color: #e9ecef;
}

/* Fix icon visibility issues */
.message-action-btn i {
    display: inline-block;
    width: 16px;
    height: 16px;
    line-height: 16px;
    text-align: center;
}

/* Make star message icon look better */
.star-btn i {
    color: #ffc107;
}

/* Modal improvements */
#starredMessagesModal .modal-body {
    max-height: 70vh;
    overflow-y: auto;
}

.input-group .send-btn {
    background-color: #4a6fa5;
    color: white;
    border-color: #4a6fa5;
    padding: 0.375rem 0.75rem;
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.input-group .send-btn i {
    display: inline-block;
    width: 1.25rem;
    height: 1.25rem;
    line-height: 1.25rem;
    text-align: center;
    font-size: 1rem;
}

.input-group .send-btn:hover {
    background-color: #395a84;
    border-color: #395a84;
}


@media (max-width: 768px) {
    #starredMessagesModal .modal-body {
        max-height: 60vh;
    }
}

/* Refresh data button styling */
.refresh-data-btn {
    margin-left: 10px;
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
    background-color: #4fc3a1;
    border-color: #4fc3a1;
    color: white;
    transition: all 0.2s ease;
}

.refresh-data-btn:hover {
    background-color: #3aa889;
    border-color: #3aa889;
    transform: translateY(-2px);
}

.refresh-data-btn .spinner-border {
    height: 1rem;
    width: 1rem;
    margin-right: 0.25rem;
    display: none;
}

@keyframes rotateAnimation {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.refresh-icon {
    margin-right: 0.25rem;
    transition: transform 0.3s ease;
}

.refresh-data-btn:hover .refresh-icon {
    animation: rotateAnimation 1s linear infinite;
}

/* Error message styling */
.error-message {
    background-color: rgba(255, 193, 7, 0.1);
    border-left: 3px solid #ffc107;
    padding: 8px 12px;
    font-size: 0.9em;
    margin-top: 8px;
    border-radius: 4px;
}

.retry-btn {
    margin-top: 8px;
    font-size: 0.85em;
    padding: 3px 8px;
}

/* Rate limit specific styling */
.rate-limit-message {
    background-color: rgba(255, 193, 7, 0.1);
    border-left: 3px solid #ffc107;
}

/* Countdown timer styling */
.countdown {
    font-weight: bold;
    color: #dc3545;
}

/* Server error styling */
.server-error-message {
    background-color: rgba(220, 53, 69, 0.1);
    border-left: 3px solid #dc3545;
}

/* Model badge styling */
.model-badge {
    font-size: 0.75rem;
    padding: 0.15rem 0.4rem;
    border-radius: 0.2rem;
    margin-left: 0.5rem;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.03em;
}

.model-badge.gemini {
    background-color: #4285f4;
    color: white;
}

.model-badge.openai {
    background-color: #10a37f;
    color: white;
}

.model-badge.fallback {
    background-color: #f4b400;
    color: #333;
}

/* New styles for the additional features */
.model-selector {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    overflow: hidden;
    background-color: var(--card-bg);
    transition: var(--transition-smooth);
}

.model-option {
    flex: 1;
    text-align: center;
    padding: 0.75rem 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
    position: relative;
}

.model-option.active {
    background-color: var(--primary-color);
    color: white;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
}

.model-option:not(.active):hover {
    background-color: rgba(74, 111, 165, 0.1);
}

.model-option.gemini {
    border-right: 1px solid var(--border-color);
}

.model-option .model-icon {
    font-size: 1.2rem;
    margin-right: 0.5rem;
}

.model-option .model-indicator {
    position: absolute;
    top: 0.3rem;
    right: 0.3rem;
    width: 0.6rem;
    height: 0.6rem;
    border-radius: 50%;
    background-color: var(--accent-color);
    display: none;
}

.model-option.active .model-indicator {
    display: block;
}

.session-selector {
    margin-bottom: 1.5rem;
}

.session-list {
    max-height: 200px;
    overflow-y: auto;
}

.session-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: var(--border-radius-sm);
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: var(--transition-smooth);
}

.session-item:hover {
    background-color: rgba(74, 111, 165, 0.1);
}

.session-item.active {
    background-color: rgba(74, 111, 165, 0.2);
    font-weight: 500;
}

.session-item-icon {
    margin-right: 0.75rem;
    opacity: 0.7;
}

.toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.toolbar-section {
    display: flex;
    align-items: center;
}

.dashboard-link {
    margin-left: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="welcome-message">
            <h2 class="app-title">Database Assistant</h2>
            <p class="text-muted">Ask me anything about your database or any general questions!</p>
        </div>
        
        <!-- New toolbar with model selector and other options -->
        <div class="toolbar mb-4">
            <div class="toolbar-section">
                <!-- Model Selection Toggle -->
                <div class="model-selector">
                    <div class="model-option gemini active" data-model="gemini" id="gemini-option">
                        <i class="fas fa-robot model-icon"></i> Gemini
                        <span class="model-indicator"></span>
                    </div>
                    <div class="model-option openai" data-model="openai" id="openai-option">
                        <i class="fas fa-brain model-icon"></i> OpenAI
                        <span class="model-indicator"></span>
                    </div>
                </div>
                
                <div class="dashboard-link">
                    <a href="{% url 'chatbot:dashboard' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-chart-line me-1"></i> Dashboard
                    </a>
                </div>
            </div>
            
            <div class="toolbar-section">
                <!-- Session Control -->
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="sessionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-history me-1"></i> Chat Sessions
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end session-list" aria-labelledby="sessionDropdown">
                        <li><h6 class="dropdown-header">Current Session</h6></li>
                        <li>
                            <a class="dropdown-item session-item active" href="#" data-session-id="{{ active_session_id }}">
                                <i class="fas fa-comments session-item-icon"></i> Current Chat
                            </a>
                        </li>
                        
                        {% if previous_sessions %}
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Previous Sessions</h6></li>
                            {% for session in previous_sessions %}
                                <li>
                                    <a class="dropdown-item session-item" href="#" data-session-id="{{ session.id }}">
                                        <i class="far fa-comments session-item-icon"></i> {{ session.get_title|truncatechars:25 }}
                                    </a>
                                </li>
                            {% endfor %}
                        {% endif %}
                        
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="#" id="new-session-btn">
                                <i class="fas fa-plus me-1"></i> New Session
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{% url 'chatbot:chat_history' %}">
                                <i class="fas fa-folder-open me-1"></i> All Chat History
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            {% if sheet_names|length > 1 %}
            <div class="sheet-selector">
                <select class="form-select" id="sheet-selector">
                    <option value="">All Data Sources</option>
                    {% for name in sheet_names %}
                        <option value="{{ name }}">{{ name|title }}</option>
                    {% endfor %}
                </select>
                <div class="form-text">Select a specific data source or query across all sources</div>
            </div>
            {% endif %}
            
            <div class="action-buttons">
                <!-- Add refresh data button -->
                <button id="refresh-data" class="btn btn-sm refresh-data-btn" title="Refresh database data">
                    <span class="spinner-border" role="status" id="refresh-spinner"></span>
                    <i class="fas fa-sync-alt refresh-icon"></i> Refresh Data
                </button>
                
                <button id="view-starred" class="btn btn-sm btn-outline-primary ms-2">
                    <i class="fas fa-star me-1"></i>View Starred
                </button>
                
                <!-- Add Reset History button -->
                <button id="reset-history" class="btn btn-sm btn-outline-danger ms-2">
                    <i class="fas fa-trash-alt me-1"></i>Reset History
                </button>
            </div>
        </div>
        
        <div class="chat-container-wrapper">
            <button class="export-btn" id="export-chat" title="Export Conversation">
                <i class="fas fa-download"></i>
            </button>
            <div class="chat-container" id="chat-container">
                <div class="bot-message message">
                    <div class="message-header">
                        <span>Assistant</span>
                        <span class="message-timestamp">Just now</span>
                    </div>
                    <div>Hello! I'm your database assistant. 
                    {% if sheet_names|length > 1 %}
                    I can answer questions about your database or any data sources. Use the dropdown above to focus on a specific source.
                    {% else %}
                    How can I help you today?
                    {% endif %}
                    </div>
                    <div class="message-source">
                        <i class="fas fa-robot me-1"></i> Google Gemini 1.5-Flash <span class="model-badge gemini">Gemini</span>
                    </div>
                    <div class="message-actions">
                        <button class="message-action-btn copy-btn" title="Copy to clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="message-action-btn star-btn" title="Star this conversation">
                            <i class="fas fa-star-half-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="typing-indicator" id="typing-indicator">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-group">
                <input type="text" class="form-control" id="user-input" placeholder="Type your message here..." aria-label="User message">
                <button class="btn btn-primary send-btn" type="button" id="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <p class="text-center text-muted small mt-3">
            <i class="fas fa-info-circle me-1"></i> 
            Using <span id="current-model">Google Gemini 1.5-Flash</span> | 
            <a href="{% url 'chatbot:dashboard' %}" class="text-muted">View Analytics</a>
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        const chatContainer = $('#chat-container');
        const userInput = $('#user-input');
        const sendBtn = $('#send-btn');
        let typingIndicator = $('#typing-indicator'); // Changed from const to let
        const sheetSelector = $('#sheet-selector');
        const exportBtn = $('#export-chat');
        const viewStarredBtn = $('#view-starred');
        const refreshDataBtn = $('#refresh-data');
        const refreshSpinner = $('#refresh-spinner');
        const resetHistoryBtn = $('#reset-history');
        const currentModelText = $('#current-model');
        
        // WebSocket setup
        let chatSocket = null;
        let activeSessionId = "{{ active_session_id }}";
        let selectedModel = "gemini"; // Default model
        let chatHistory = [];
        let refreshDataMode = false;
        let isRetrying = false;
        let lastUserMessage = '';
        let retryWaitTime = 0;
        let retryCountdown;
        
        // Add a status display for debugging
        $('<div id="connection-status" style="position: fixed; bottom: 10px; right: 10px; padding: 5px 10px; background: rgba(0,0,0,0.5); color: white; font-size: 12px; border-radius: 5px; z-index: 9999;"></div>').appendTo('body');
        
        function updateConnectionStatus(status) {
            $('#connection-status').text('WebSocket: ' + status);
        }
        
        // Initialize WebSocket connection
        function connectWebSocket() {
            // Generate a unique room name based on the user's session ID
            const roomName = 'user_{{ request.user.id }}_' + activeSessionId;
            
            // Close existing connection if any
            if (chatSocket) {
                chatSocket.close();
            }
            
            // Create new WebSocket connection
            const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${wsScheme}://${window.location.host}/ws/chat/${roomName}/`;
            
            console.log('Connecting to WebSocket:', wsUrl);
            updateConnectionStatus('Connecting...');
            
            chatSocket = new WebSocket(wsUrl);
            
            chatSocket.onopen = function(e) {
                console.log('WebSocket connection established successfully');
                updateConnectionStatus('Connected');
                
                // Send a test message to verify connection works both ways
                try {
                    chatSocket.send(JSON.stringify({
                        'type': 'connection_test',
                        'message': 'Connection test'
                    }));
                    console.log('Test message sent to WebSocket server');
                } catch (error) {
                    console.error('Error sending test message:', error);
                }
            };
            
            chatSocket.onclose = function(e) {
                console.log('WebSocket connection closed. Reconnecting...');
                updateConnectionStatus('Disconnected - Reconnecting...');
                // Try to reconnect after 1 second
                setTimeout(connectWebSocket, 1000);
            };
            
            chatSocket.onmessage = function(e) {
                console.log('WebSocket message received:', e.data);
                
                try {
                    const data = JSON.parse(e.data);
                    console.log('Message data parsed:', data);
                    
                    if (data.type === 'typing') {
                        // Show/hide typing indicator
                        if (data.status === 'typing') {
                            typingIndicator.show();
                            console.log('Typing indicator shown');
                        } else {
                            typingIndicator.hide();
                            console.log('Typing indicator hidden');
                        }
                    }
                    else if (data.type === 'message') {
                        // Hide typing indicator
                        typingIndicator.hide();
                        
                        // Add the message to the chat
                        if (data.sender === 'assistant') {
                            console.log('Adding assistant message to chat:', data.message.substring(0, 50) + '...');
                            
                            // First add a temporary placeholder with ID
                            const msgId = 'msg_' + new Date().getTime();
                            const tempMsg = $(`<div id="${msgId}" class="bot-message message"><div class="message-header"><span>Assistant</span><span class="message-timestamp">${getCurrentTimestamp()}</span></div><div>Processing response...</div></div>`);
                            typingIndicator.before(tempMsg);
                            
                            // Then replace it with the actual message (gives better visual feedback)
                            setTimeout(() => {
                                addMessage(data.message, 'bot', data.source || 'gemini', data.sheet_name);
                                tempMsg.remove();
                            }, 100);
                        }
                    } else if (data.type === 'connection_test_response') {
                        console.log('Connection test successful, server responded:', data.message);
                    }
                } catch (error) {
                    console.error('Error processing WebSocket message:', error);
                    
                    // Try to add raw message as fallback
                    try {
                        addMessage("Error parsing response. Raw data: " + e.data.substring(0, 100) + "...", 'bot', 'error');
                    } catch (err) {
                        console.error('Error adding fallback message:', err);
                    }
                }
            };
            
            chatSocket.onerror = function(e) {
                console.error('WebSocket error:', e);
                updateConnectionStatus('Error');
                // Fall back to AJAX if WebSocket fails
                console.log('Falling back to AJAX for communication');
            };
        }
        
        // Connect WebSocket on page load
        connectWebSocket();
        
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Function to get current timestamp
        function getCurrentTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Function to enhance message formatting
        function formatMessage(content) {
            // Simple Markdown-like formatting for code
            // Convert code blocks (```code```)
            if (content.includes('```')) {
                content = content.replace(/```(?:(\w+)\n)?([\s\S]*?)```/g, function(match, language, code) {
                    return `<pre><code>${code.trim()}</code></pre>`;
                });
            }
            
            // Convert inline code (`code`)
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Convert line breaks to <br>
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }

        // Function to get model display information
        function getModelInfo(source) {
            switch(source) {
                case 'gemini':
                    return {
                        icon: '<i class="fas fa-robot me-1"></i>',
                        name: 'Google Gemini 1.5-Flash',
                        badge: '<span class="model-badge gemini">Gemini</span>'
                    };
                case 'openai':
                    return {
                        icon: '<i class="fas fa-robot me-1"></i>',
                        name: 'OpenAI GPT-4o-mini',
                        badge: '<span class="model-badge openai">GPT</span>'
                    };
                case 'openai-fallback':
                    return {
                        icon: '<i class="fas fa-robot me-1"></i>',
                        name: 'OpenAI GPT-4o-mini (Fallback)',
                        badge: '<span class="model-badge fallback">GPT</span>'
                    };
                case 'error':
                    return {
                        icon: '<i class="fas fa-exclamation-triangle me-1"></i>',
                        name: 'System Message',
                        badge: ''
                    };
                case 'System':
                    return {
                        icon: '<i class="fas fa-info-circle me-1"></i>',
                        name: 'System',
                        badge: ''
                    };
                default:
                    return {
                        icon: '<i class="fas fa-comment me-1"></i>',
                        name: source || 'Unknown',
                        badge: ''
                    };
            }
        }

        // Function to save chat history to localStorage
        function saveChatHistory() {
            try {
                // Save messages from DOM to preserve formatting and timestamps
                const savedMessages = [];
                $('.message').each(function() {
                    const messageEl = $(this);
                    const isBot = messageEl.hasClass('bot-message');
                    const content = messageEl.find('div:nth-child(2)').html().trim();
                    const timestamp = messageEl.find('.message-timestamp').text().trim();
                    const source = isBot ? messageEl.find('.message-source').text().trim() : null;
                    
                    // Check if message contains sheet badge
                    let sheetName = null;
                    const sheetBadge = messageEl.find('.sheet-badge');
                    if (sheetBadge.length > 0) {
                        sheetName = sheetBadge.text().replace('Source:', '').trim();
                    }
                    
                    // Store message
                    savedMessages.push({
                        content: content,
                        sender: isBot ? 'assistant' : 'user',
                        timestamp: timestamp,
                        source: source,
                        sheetName: sheetName
                    });
                });
                
                // Save to localStorage
                localStorage.setItem('pmChatbot_chatHistory', JSON.stringify(savedMessages));
                
                // Also save for API history tracking
                chatHistory = savedMessages.map(msg => ({
                    role: msg.sender,
                    content: $(document.createElement('div')).html(msg.content).text() // Convert HTML back to plain text
                }));
                
                console.log('Chat history saved:', savedMessages.length, 'messages');
            } catch (e) {
                console.error('Error saving chat history:', e);
            }
        }
        
        // Function to restore chat history from localStorage
        function restoreChatHistory() {
            try {
                // Get saved messages from database instead of localStorage
                $.ajax({
                    type: 'GET',
                    url: `/session/${activeSessionId}/messages/`,
                    success: function(data) {
                        if (data.messages && data.messages.length > 0) {
                            // Clear initial welcome message
                            chatContainer.empty();
                            
                            // Add typing indicator back
                            chatContainer.append('<div class="typing-indicator" id="typing-indicator"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>');
                            // Update the reference to the typing indicator instead of reassigning
                            typingIndicator = $('#typing-indicator');
                            
                            // Add all messages to the chat
                            data.messages.forEach(msg => {
                                const isBot = msg.role === 'assistant';
                                const messageClass = isBot ? 'bot-message' : 'user-message';
                                const senderName = isBot ? 'Assistant' : 'You';
                                const timestamp = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                
                                let messageHTML = `<div class="${messageClass} message">`;
                                messageHTML += `<div class="message-header">
                                            <span>${senderName}</span>
                                            <span class="message-timestamp">${timestamp}</span>
                                        </div>`;
                                messageHTML += `<div>${isBot ? formatMessage(msg.content) : msg.content}</div>`;
                                
                                if (isBot && msg.model) {
                                    const modelInfo = getModelInfo(msg.model);
                                    messageHTML += `<div class="message-source">${modelInfo.icon} ${modelInfo.name}${modelInfo.badge}</div>`;
                                    
                                    // Add message actions for bot messages
                                    messageHTML += `
                                        <div class="message-actions">
                                            <button class="message-action-btn copy-btn" title="Copy to clipboard">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="message-action-btn star-btn" title="Star this conversation">
                                                <i class="fas fa-star-half-alt"></i>
                                            </button>
                                        </div>
                                    `;
                                }
                                
                                messageHTML += `</div>`;
                                typingIndicator.before(messageHTML);
                                
                                // Add to chat history array
                                chatHistory.push({
                                    role: msg.role,
                                    content: msg.content
                                });
                            });
                            
                            // Restore starred messages
                            restoreStarredMessages();
                            
                            // Scroll to bottom
                            setTimeout(() => {
                                chatContainer.scrollTop(chatContainer.prop('scrollHeight'));
                            }, 100);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error loading chat history:", error);
                        // Fall back to localStorage if server fails
                        restoreLocalHistory();
                    }
                });
            } catch (e) {
                console.error('Error restoring chat history:', e);
                // Fall back to localStorage
                restoreLocalHistory();
            }
        }
        
        // Fallback to localStorage for history
        function restoreLocalHistory() {
            try {
                const savedMessages = JSON.parse(localStorage.getItem('pmChatbot_chatHistory'));
                if (savedMessages && savedMessages.length > 0) {
                    // Clear initial welcome message if we have saved history
                    chatContainer.empty();
                    
                    // Add typing indicator back
                    chatContainer.append('<div class="typing-indicator" id="typing-indicator"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>');
                    // Update the reference to the typing indicator instead of reassigning
                    typingIndicator = $('#typing-indicator');
                    
                    // For each saved message, recreate it in the chat
                    savedMessages.forEach(msg => {
                        const isBot = msg.sender === 'assistant';
                        const messageClass = isBot ? 'bot-message' : 'user-message';
                        const senderName = isBot ? 'Assistant' : 'You';
                        
                        let messageHTML = `<div class="${messageClass} message">`;
                        messageHTML += `<div class="message-header">
                                    <span>${senderName}</span>
                                    <span class="message-timestamp">${msg.timestamp}</span>
                                </div>`;
                        messageHTML += `<div>${msg.content}</div>`;
                        
                        if (isBot) {
                            // Add source info if available
                            if (msg.source) {
                                // Extract model name from source string
                                const modelNames = {
                                    'Google Gemini 1.5-Flash': 'gemini',
                                    'OpenAI GPT-4o-mini': 'openai',
                                    'OpenAI GPT-4o-mini (Fallback)': 'openai-fallback'
                                };
                                
                                // Find which model was used
                                let modelType = 'unknown';
                                for (const [name, type] of Object.entries(modelNames)) {
                                    if (msg.source.includes(name)) {
                                        modelType = type;
                                        break;
                                    }
                                }
                                
                                const modelInfo = getModelInfo(modelType);
                                let sourceInfo = `${modelInfo.icon} ${modelInfo.name}${modelInfo.badge}`;
                                
                                if (msg.sheetName) {
                                    sourceInfo += ` <span class="badge bg-secondary sheet-badge">Source: ${msg.sheetName}</span>`;
                                }
                                
                                messageHTML += `<div class="message-source">${sourceInfo}</div>`;
                            }
                            
                            // Add message actions for bot messages
                            messageHTML += `
                                <div class="message-actions">
                                    <button class="message-action-btn copy-btn" title="Copy to clipboard">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="message-action-btn star-btn" title="Star this conversation">
                                        <i class="fas fa-star-half-alt"></i>
                                    </button>
                                </div>
                            `;
                        }
                        
                        messageHTML += `</div>`;
                        typingIndicator.before(messageHTML);
                        
                        // Add to chat history array for API context
                        chatHistory.push({
                            role: msg.sender,
                            content: $(document.createElement('div')).html(msg.content).text() // Convert HTML to plain text
                        });
                    });
                    
                    // Restore any starred messages
                    restoreStarredMessages();
                    
                    console.log('Chat history restored:', savedMessages.length, 'messages');
                    
                    // Scroll to bottom
                    setTimeout(() => {
                        chatContainer.scrollTop(chatContainer.prop('scrollHeight'));
                    }, 100);
                }
            } catch (e) {
                console.error('Error restoring chat history:', e);
            }
        }
        
        // Initialize chat history
        function initializeChatHistory() {
            // Restore chat from database
            restoreChatHistory();
            
            // Keep chat history in sync
            const observer = new MutationObserver(function(mutations) {
                // When chat content changes, save it
                saveChatHistory();
            });
            
            // Observe chat container for changes to its children
            observer.observe(chatContainer[0], { childList: true, subtree: true });
        }
        
        // Function to add a new message to the chat
        function addMessage(content, sender, source = null, sheetName = null) {
            console.log(`Adding message: sender=${sender}, content length=${content ? content.length : 0}, source=${source}`);
            
            if (!content) {
                console.error('Attempted to add empty message');
                return;
            }
            
            const messageClass = sender === 'user' ? 'user-message' : 'bot-message';
            const senderName = sender === 'user' ? 'You' : 'Assistant';
            const timestamp = getCurrentTimestamp();
            
            try {
                // Format the message content for the bot
                const formattedContent = sender === 'user' ? content : formatMessage(content);
                
                let messageHTML = `<div class="${messageClass} message">`;
                messageHTML += `<div class="message-header">
                                <span>${senderName}</span>
                                <span class="message-timestamp">${timestamp}</span>
                            </div>`;
                messageHTML += `<div>${formattedContent}</div>`;

                if (sender !== 'user') {
                    const modelInfo = getModelInfo(source);
                    let sourceInfo = '';
                    
                    if (source) {
                        sourceInfo += `${modelInfo.icon} ${modelInfo.name}${modelInfo.badge}`;
                    }
                    
                    if (sheetName) {
                        sourceInfo += ` <span class="badge bg-secondary sheet-badge">Source: ${sheetName}</span>`;
                    }
                    
                    if (sourceInfo) {
                        messageHTML += `<div class="message-source">${sourceInfo}</div>`;
                    }

                    // Add rate limit specific UI if needed
                    if ((source === 'openai-fallback' || source === 'gemini-fallback') && content.includes('using backup AI service')) {
                        // Remove the fallback notice from the content since we're displaying it properly in the UI
                        const cleanContent = content.replace(/\n\n\(Answered using backup AI service.*\)/, '');
                        
                        // Find the content div we just added and update it
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = messageHTML;
                        const contentDiv = tempDiv.querySelector('div:nth-child(2)');
                        contentDiv.innerHTML = formatMessage(cleanContent);
                        messageHTML = tempDiv.innerHTML;
                    }
                    
                    // Add message actions for bot messages
                    messageHTML += `
                        <div class="message-actions">
                            <button class="message-action-btn copy-btn" title="Copy to clipboard">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="message-action-btn star-btn" title="Star this conversation">
                                <i class="fas fa-star-half-alt"></i>
                            </button>
                        </div>
                    `;
                }

                messageHTML += `</div>`;

                // Create element and insert it properly
                const messageElement = $(messageHTML);
                typingIndicator.before(messageElement);
                
                // Force a reflow to ensure the message is rendered
                messageElement[0].offsetHeight;
                
                // Ensure the message is visible by scrolling to bottom
                chatContainer.scrollTop(chatContainer.prop('scrollHeight'));
                
                // Start countdown if rate limited
                if (source === 'fallback' && content.includes('high demand')) {
                    startRetryCountdown();
                }

                // Add to chat history (don't add error messages to history)
                if (source !== 'error' && source !== 'fallback') {
                    chatHistory.push({
                        role: sender === 'user' ? 'user' : 'assistant',
                        content: content
                    });

                    // Keep history at a reasonable size (last 20 messages)
                    if (chatHistory.length > 20) {
                        chatHistory = chatHistory.slice(chatHistory.length - 20);
                    }
                }
                
                console.log('Message added successfully');
                return messageElement;
            } catch (error) {
                console.error('Error adding message to chat:', error);
                // Add a simple message as fallback
                typingIndicator.before(`<div class="${messageClass} message"><div>Error showing message. Please try again.</div></div>`);
            }
        }

        // Function to start retry countdown
        function startRetryCountdown() {
            const countdownEl = $('#retry-countdown');
            countdownEl.text(`(Wait ${retryWaitTime} seconds)`);
            
            clearInterval(retryCountdown);
            retryCountdown = setInterval(() => {
                retryWaitTime -= 1;
                if (retryWaitTime <= 0) {
                    clearInterval(retryCountdown);
                    countdownEl.text('(Ready to retry)');
                    $('#retry-btn').prop('disabled', false);
                } else {
                    countdownEl.text(`(Wait ${retryWaitTime} seconds)`);
                    $('#retry-btn').prop('disabled', true);
                }
            }, 1000);
        }

        // Function to send message to backend
        function sendMessage(isRetry = false) {
            let message;
            if (isRetry) {
                message = lastUserMessage;
                isRetrying = false;
            } else {
                message = userInput.val().trim();
                lastUserMessage = message; // Store for potential retry
            }
            
            if (message === '') return;

            // Get selected sheet if any
            const selectedSheet = sheetSelector.val();

            // Only add user message to chat if not retrying
            if (!isRetry) {
                const userMessageElement = addMessage(message, 'user');
                
                // Clear input
                userInput.val('');
            }

            // Show typing indicator
            typingIndicator.show();
            
            // Generate a unique message ID
            const messageId = 'msg_' + new Date().getTime();
            
            // Check if WebSocket is connected
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                // Use WebSocket for real-time communication
                try {
                    console.log('Sending message via WebSocket:', message);
                    
                    const payload = JSON.stringify({
                        'message': message,
                        'history': chatHistory.slice(-10), // Limit history size to avoid large packets
                        'model': selectedModel,
                        'sheet_name': selectedSheet,
                        'refresh_data': refreshDataMode,
                        'message_id': messageId,
                        'session_id': activeSessionId
                    });
                    
                    console.log('WebSocket payload:', payload.substring(0, 200) + '...');
                    chatSocket.send(payload);
                } catch (e) {
                    console.error("WebSocket send error:", e);
                    fallbackToAjax(message, selectedSheet, messageId);
                }
            } else {
                console.log("WebSocket not connected (status:" + (chatSocket ? chatSocket.readyState : 'null') + "), using AJAX fallback");
                fallbackToAjax(message, selectedSheet, messageId);
            }
        }
        
        // AJAX fallback when WebSocket is unavailable
        function fallbackToAjax(message, selectedSheet, messageId) {
            // Fall back to AJAX if WebSocket is not available
            $.ajax({
                type: 'POST',
                url: '/chat/',
                contentType: 'application/json',
                data: JSON.stringify({
                    message: message,
                    history: chatHistory,
                    model: selectedModel,
                    sheet_name: selectedSheet,
                    refresh_data: refreshDataMode,
                    session_id: activeSessionId,
                    message_id: messageId
                }),
                beforeSend: function (xhr) {
                    // Add the CSRF token to the request header
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                },
                success: function (data) {
                    // Reset refresh data mode after use
                    refreshDataMode = false;
                    
                    // Hide typing indicator
                    typingIndicator.hide();

                    // Add bot response to chat
                    addMessage(
                        data.response, 
                        'bot', 
                        data.source, 
                        data.sheet_name
                    );
                    
                    // If this was a successful retry, increase wait time for future rate limits
                    if (isRetrying && data.source === 'openai') {
                        retryWaitTime = Math.min(retryWaitTime * 2, 300); // Max 5 minutes
                    }
                },
                error: function (xhr, status, error) {
                    // Reset refresh data mode after use
                    refreshDataMode = false;
                    
                    // Hide typing indicator
                    typingIndicator.hide();

                    // Show error message
                    let errorMessage = "Sorry, I encountered an error processing your request.";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage += " Details: " + xhr.responseJSON.error;
                    }
                    addMessage(errorMessage, 'bot', 'error');

                    console.error("AJAX Error:", status, error);
                }
            });
        }

        // Handle model selection toggle
        $('.model-option').on('click', function() {
            // Remove active class from all options
            $('.model-option').removeClass('active');
            
            // Add active class to clicked option
            $(this).addClass('active');
            
            // Update selected model
            selectedModel = $(this).data('model');
            
            // Update model text in the footer
            if (selectedModel === 'gemini') {
                currentModelText.text('Google Gemini 1.5-Flash');
            } else {
                currentModelText.text('OpenAI GPT-4o-mini');
            }
            
            // Add a system message about the model change
            addMessage(`Model switched to ${selectedModel === 'gemini' ? 'Google Gemini' : 'OpenAI'}.`, 'bot', 'System');
        });
        
        // Handle session switching
        $(document).on('click', '.session-item', function(e) {
            e.preventDefault();
            
            const sessionId = $(this).data('session-id');
            
            if (sessionId === activeSessionId) {
                // Already on this session
                return;
            }
            
            // Show loading state
            chatContainer.html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Loading chat history...</p></div>');
            
            // Switch to the selected session
            $.ajax({
                type: 'POST',
                url: '/switch-session/',
                contentType: 'application/json',
                data: JSON.stringify({
                    session_id: sessionId
                }),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                },
                success: function(data) {
                    // Update active session ID
                    activeSessionId = data.session_id;
                    
                    // Update UI to show the session is active
                    $('.session-item').removeClass('active');
                    $(`.session-item[data-session-id="${sessionId}"]`).addClass('active');
                    
                    // Clear chat container
                    chatContainer.empty();
                    
                    // Add typing indicator back
                    chatContainer.append('<div class="typing-indicator" id="typing-indicator"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>');
                    // Update the reference to the typing indicator instead of reassigning
                    typingIndicator = $('#typing-indicator');
                    
                    // Clear chat history
                    chatHistory = [];
                    
                    // Add messages from the session
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            const isBot = msg.role === 'assistant';
                            addMessage(
                                msg.content,
                                isBot ? 'bot' : 'user',
                                isBot ? msg.model : null
                            );
                        });
                    } else {
                        // Add a welcome message if no messages
                        addMessage('Starting a new conversation. How can I help you today?', 'bot', 'System');
                    }
                    
                    // Reconnect WebSocket for the new session
                    connectWebSocket();
                },
                error: function(xhr, status, error) {
                    console.error("Error switching session:", error);
                    chatContainer.html(`<div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error loading chat session. Please try again.
                    </div>`);
                }
            });
        });
        
        // Handle creating a new session
        $('#new-session-btn').on('click', function(e) {
            e.preventDefault();
            
            // Show loading state
            chatContainer.html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Creating new chat session...</p></div>');
            
            $.ajax({
                type: 'POST',
                url: '/create-session/',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                },
                success: function(data) {
                    // Update active session ID
                    activeSessionId = data.session_id;
                    
                    // Reload the page to show the new session
                    window.location.reload();
                },
                error: function(xhr, status, error) {
                    console.error("Error creating new session:", error);
                    chatContainer.html(`<div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error creating new chat session. Please try again.
                    </div>`);
                }
            });
        });
        
        // Handle retry button click
        $(document).on('click', '#retry-btn', function() {
            isRetrying = true;
            sendMessage(true);
        });

        // Handle refresh data button click
        refreshDataBtn.on('click', function() {
            // Show spinner
            refreshSpinner.show();
            $(this).prop('disabled', true);
            
            // Call the refresh endpoint
            $.ajax({
                type: 'GET',
                url: '/refresh-data/',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                },
                success: function(data) {
                    // Add system message about refresh
                    addMessage(data.message, 'bot', 'System');
                    
                    // Set flag to bypass cache on next request
                    refreshDataMode = true;
                },
                error: function(xhr, status, error) {
                    // Add error message
                    let errorMessage = "Sorry, I couldn't refresh the database data.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += " Details: " + xhr.responseJSON.message;
                    }
                    addMessage(errorMessage, 'bot', 'Error');
                    
                    console.error("Refresh Error:", status, error);
                },
                complete: function() {
                    // Hide spinner and re-enable button
                    refreshSpinner.hide();
                    refreshDataBtn.prop('disabled', false);
                }
            });
        });
        
        // Handle reset history button click
        resetHistoryBtn.on('click', function() {
            if (confirm('Are you sure you want to reset the chat history? This will clear all messages.')) {
                // Show loading indicator
                chatContainer.html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Resetting chat history...</p></div>');
                
                // Call the backend to clear messages from the database
                $.ajax({
                    type: 'POST',
                    url: '/reset-chat/',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                    },
                    success: function(data) {
                        // Clear localStorage as well
                        localStorage.removeItem('pmChatbot_chatHistory');
                        
                        // Clear chat window
                        chatContainer.empty();
                        
                        // Add typing indicator back
                        chatContainer.append('<div class="typing-indicator" id="typing-indicator"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>');
                        // Update the reference to the typing indicator
                        typingIndicator = $('#typing-indicator');
                        
                        // Reset chat history array
                        chatHistory = [];
                        
                        // Show welcome message
                        let welcomeHTML = `
                        <div class="bot-message message">
                            <div class="message-header">
                                <span>Assistant</span>
                                <span class="message-timestamp">${getCurrentTimestamp()}</span>
                            </div>
                            <div>Hello! I'm your database assistant. How can I help you today?</div>
                            <div class="message-source">
                                <i class="fas fa-info-circle me-1"></i> System
                            </div>
                            <div class="message-actions">
                                <button class="message-action-btn copy-btn" title="Copy to clipboard">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="message-action-btn star-btn" title="Star this conversation">
                                    <i class="fas fa-star-half-alt"></i>
                                </button>
                            </div>
                        </div>`;
                        
                        chatContainer.append(welcomeHTML);
                    },
                    error: function(xhr, status, error) {
                        // Show error message
                        chatContainer.html(`<div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error resetting chat history. Please try again.
                        </div>`);
                        console.error("Error resetting chat history:", error);
                    }
                });
            }
        });

        // Send button click handler
        sendBtn.on('click', function() {
            sendMessage();
        });

        // Send message on Enter key
        userInput.on('keypress', function (e) {
            if (e.which === 13) {
                sendMessage();
            }
        });

        // Sheet selector change handler - optionally add a message about changing context
        sheetSelector.on('change', function () {
            const selectedSheet = $(this).val();
            const message = selectedSheet
                ? `Now focusing on the "${selectedSheet}" data source.`
                : "Now considering all data sources.";

            addMessage(message, 'bot', 'System');
        });

        // Handle message actions - Star button
        $(document).on('click', '.star-btn', function() {
            const messageEl = $(this).closest('.message');
            const messageContent = messageEl.find('div:nth-child(2)').html().trim(); // Use HTML to preserve formatting
            const timestamp = messageEl.find('.message-timestamp').text();
            const isUser = messageEl.hasClass('user-message');
            
            // Get current starred messages with extra safety
            let starredMessages = [];
            try {
                const stored = localStorage.getItem('pmChatbot_starredMessages');
                if (stored) {
                    starredMessages = JSON.parse(stored);
                    // Validate it's an array
                    if (!Array.isArray(starredMessages)) {
                        console.error("Stored starred messages is not an array:", starredMessages);
                        starredMessages = [];
                    }
                }
            } catch (e) {
                console.error("Error parsing starred messages:", e);
                localStorage.removeItem('pmChatbot_starredMessages');
            }
            
            // Only allow starring bot messages (since we'll include the preceding user message)
            if (isUser) {
                alert("You can only star assistant responses. The associated question will be included automatically.");
                return;
            }
            
            // Find the preceding user message if this is a bot message
            let precedingUserMessage = null;
            if (!isUser) {
                // Get the previous message element
                const prevMessageEl = messageEl.prev('.message.user-message');
                if (prevMessageEl.length > 0) {
                    precedingUserMessage = {
                        content: prevMessageEl.find('div:nth-child(2)').html().trim(),
                        timestamp: prevMessageEl.find('.message-timestamp').text()
                    };
                }
            }
            
            // Check if message is already starred
            const messageIndex = starredMessages.findIndex(msg =>
                msg.content === messageContent && msg.timestamp === timestamp);
            
            if (messageIndex !== -1) {
                // Already starred - remove it
                messageEl.removeClass('starred');
                $(this).html('<i class="fas fa-star-half-alt"></i>');
                
                // Remove from array and update localStorage
                starredMessages.splice(messageIndex, 1);
            } else {
                // Not starred - add it
                messageEl.addClass('starred');
                $(this).html('<i class="fas fa-star"></i>');
                
                // Add to localStorage with userQuestion
                starredMessages.push({
                    content: messageContent,
                    timestamp: timestamp,
                    isUser: isUser,
                    userQuestion: precedingUserMessage
                });
            }
            
            // Save the updated array
            localStorage.setItem('pmChatbot_starredMessages', JSON.stringify(starredMessages));
            console.log("Updated localStorage:", localStorage.getItem('pmChatbot_starredMessages'));
        });

        // Handle message actions - Copy button
        $(document).on('click', '.copy-btn', function() {
            const messageEl = $(this).closest('.message');
            const textToCopy = messageEl.find('div:nth-child(2)').text().trim();
            
            navigator.clipboard.writeText(textToCopy).then(function() {
                // Show temporary feedback
                const originalIcon = $(this).html();
                $(this).html('<i class="fas fa-check"></i>');
                setTimeout(() => {
                    $(this).html(originalIcon);
                }, 1500);
            }.bind(this), function() {
                console.error('Failed to copy text');
            });
        });

        // Export chat functionality
        exportBtn.on('click', function() {
            const conversationText = [];
            
            $('.message').each(function() {
                const isBot = $(this).hasClass('bot-message');
                const sender = isBot ? "Assistant" : "You";
                const timestamp = $(this).find('.message-timestamp').text();
                const content = $(this).find('div:nth-child(2)').text().trim();
                
                conversationText.push(`[${timestamp}] ${sender}: ${content}`);
            });
            
            const exportText = conversationText.join('\n\n');
            const blob = new Blob([exportText], {type: "text/plain;charset=utf-8"});
            
            // Create a link element to download the file
            const a = document.createElement("a");
            const date = new Date().toISOString().slice(0,10);
            a.href = URL.createObjectURL(blob);
            a.download = `chat_export_${date}.txt`;
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        viewStarredBtn.on('click', function () {
            // Log the localStorage state for debugging
            console.log("Current localStorage:", localStorage);
            console.log("pmChatbot_starredMessages:", localStorage.getItem('pmChatbot_starredMessages'));

            // Parse starredMessages, with extra safety against null or malformed JSON
            let starredMessages = [];
            try {
                const stored = localStorage.getItem('pmChatbot_starredMessages');
                if (stored) {
                    starredMessages = JSON.parse(stored);
                }
                // Validate the structure
                if (!Array.isArray(starredMessages)) {
                    console.error("Stored starred messages is not an array:", starredMessages);
                    starredMessages = [];
                }
            } catch (e) {
                console.error("Error parsing starred messages:", e);
                // Clear corrupt data
                localStorage.removeItem('pmChatbot_starredMessages');
            }

            console.log("Parsed starred messages:", starredMessages);

            const modalHTML = `
    <div class="modal fade" id="starredMessagesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-star me-2"></i>Starred Conversations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="starred-messages-container">
                        ${starredMessages.length === 0 ?
                    '<p class="text-center py-4">No starred conversations found.</p>' :
                    starredMessages.map((message, index) => `
                            <div class="starred-conversation p-3 mb-4 rounded shadow-sm border">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-primary">Conversation #${index + 1}</span>
                                    <button class="btn btn-sm btn-outline-danger remove-star" data-index="${index}">
                                        <i class="fas fa-trash-alt"></i> Remove
                                    </button>
                                </div>
                                
                                ${message.userQuestion ? `
                                <div class="user-question p-3 rounded bg-primary bg-opacity-10 border-start border-primary border-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold">You</span>
                                        <small class="text-muted">${message.userQuestion.timestamp}</small>
                                    </div>
                                    <div class="message-content">${message.userQuestion.content}</div>
                                </div>` : ''}
                                
                                <div class="assistant-response p-3 rounded mt-2 bg-light border-start border-success border-3" style="background-color: #e2f0fb !important; color: #0a2540 !important;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold">Assistant</span>
                                        <small class="text-muted">${message.timestamp}</small>
                                    </div>
                                    <div class="message-content" style="color: #0a2540 !important;">${message.content}</div>
                                </div>
                            </div>
                          `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="clear-starred">Clear All Starred</button>
                </div>
            </div>
        </div>
    </div>
    `;

            $('body').append(modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('starredMessagesModal'));
            modal.show();

            // Add individual "Remove" button functionality
            $('.remove-star').on('click', function () {
                const index = $(this).data('index');
                starredMessages.splice(index, 1);
                localStorage.setItem('pmChatbot_starredMessages', JSON.stringify(starredMessages));

                // Remove the conversation from the display
                $(this).closest('.starred-conversation').fadeOut(300, function () {
                    $(this).remove();

                    // If no conversations left, show the "no starred" message
                    if (starredMessages.length === 0) {
                        $('.starred-messages-container').html('<p class="text-center py-4">No starred conversations found.</p>');
                    }
                });

                // Update star icons in the chat
                updateStarredIcons();
            });

            // Add "Clear All Starred" functionality
            $('#clear-starred').on('click', function () {
                if (confirm('Are you sure you want to clear all starred messages?')) {
                    // Clear the localStorage
                    localStorage.removeItem('pmChatbot_starredMessages');

                    // Update UI to show no starred messages
                    $('.starred-messages-container').html('<p class="text-center py-4">No starred conversations found.</p>');

                    // Remove starred classes from all messages
                    updateStarredIcons();
                }
            });

            $('#starredMessagesModal').on('hidden.bs.modal', function () {
                $(this).remove();
            });
        });

        // Function to update all starred icons in the chat
        function updateStarredIcons() {
            // Get current starred messages
            let starredMessages = [];
            try {
                const stored = localStorage.getItem('pmChatbot_starredMessages');
                if (stored) {
                    starredMessages = JSON.parse(stored);
                }
            } catch (e) {
                console.error("Error parsing starred messages:", e);
            }

            // Remove all starred classes first
            $('.message.starred').removeClass('starred');
            $('.star-btn').html('<i class="fas fa-star-half-alt"></i>');

            // Apply starred class to currently starred messages
            $('.message.bot-message').each(function () {
                const messageEl = $(this);
                const messageContent = messageEl.find('div:nth-child(2)').html().trim();
                const timestamp = messageEl.find('.message-timestamp').text();

                // Check if this message is in the starred list
                const isStarred = starredMessages.some(msg =>
                    msg.content === messageContent && msg.timestamp === timestamp);

                if (isStarred) {
                    messageEl.addClass('starred');
                    messageEl.find('.star-btn').html('<i class="fas fa-star"></i>');
                }
            });
        }

        // Add debug logging when the page loads
        $(document).ready(function () {
            // Add logging on page load
            console.log("Page loaded - localStorage state:", localStorage);
            console.log("pmChatbot_starredMessages:", localStorage.getItem('pmChatbot_starredMessages'));

            // Clear any corrupt localStorage data
            try {
                const stored = localStorage.getItem('pmChatbot_starredMessages');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (!Array.isArray(parsed)) {
                        console.error("Invalid stored starred messages format - clearing localStorage");
                        localStorage.removeItem('pmChatbot_starredMessages');
                    }
                }
            } catch (e) {
                console.error("Error parsing starred messages - clearing localStorage:", e);
                localStorage.removeItem('pmChatbot_starredMessages');
            }

            // Rest of your initialization code...
        });

        // Function to restore starred messages from localStorage
        function restoreStarredMessages() {
            const starredMessages = JSON.parse(localStorage.getItem('pmChatbot_starredMessages')) || [];
            
            // For each message in the chat
            $('.message').each(function() {
                const messageEl = $(this);
                const messageContent = messageEl.find('div:nth-child(2)').html().trim();
                const timestamp = messageEl.find('.message-timestamp').text();
                
                // Check if this message is in the starred list
                const isStarred = starredMessages.some(msg => 
                    msg.content === messageContent && msg.timestamp === timestamp);
                
                if (isStarred) {
                    messageEl.addClass('starred');
                    messageEl.find('.star-btn').html('<i class="fas fa-star"></i>');
                }
            });
        }
        
        // Call restore starred messages when the page loads
        restoreStarredMessages();
        
        // Initialize chat history
        initializeChatHistory();
        
        // Focus input on page load
        userInput.focus();
    });
</script>
{% endblock %}